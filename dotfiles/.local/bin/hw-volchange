#! /usr/bin/env nu

# amixer set Master 5%-/+
def main [change: int, --abs] {
    let vol = pacmd list-sinks | parse -r "\tvolume: .*(?<volume> \\d+)%" | get 0 | get volume | into int;
    mut new_vol = if $abs {$change} else {$vol + $change};
    if ($vol == 0) and ($new_vol == 0) {
        $new_vol = 100;
    }
    # let prefix = if $abs {''} else { if ($change >= 0) {'+'} else {'-'}};
    # let abs_change = $change | math abs;
    let limited_vol = [$new_vol, 100] | math min;
    # pacmd list-sinks | grep name: | split row "\n" | parse "\tname: <{name}>" | each {|e| pactl set-sink-volume $e.name $'($prefix)($abs_change)%'};
    pacmd list-sinks | parse "\tname: <{name}>" | each {|e| pactl set-sink-volume $e.name $'($limited_vol)%'};
}
# pacmd list-sinks | parse -r "\tname: <(?P<name>.*)>.*\tvolume:.* (?P<vol>\\d+?)%/s"

